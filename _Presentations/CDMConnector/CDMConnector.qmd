---
title: "Working with the OMOP CDM from R"
format:
  revealjs: 
    theme: [simple, styleOU.scss]
    incremental: true   
    slide-number: true
    chalkboard: true
    preview-links: auto
    margin: 0.07
    code-link: true
    code-line-numbers: false
    height: 900
    width: 1600
    footer: "Conducting 'Off-The-Shelf' Characterization Studies Using DARWIN EU Tools and the OMOP CDM"
execute:
  echo: true
  eval: true
editor: visual
---

```{r, echo = FALSE}
options(width = 120)
```

## Standarisation of the data format

![The OMOP Common Data Model](https://ohdsi.github.io/TheBookOfOhdsi/images/CommonDataModel/cdmDiagram.png)

## Connect to eunomia

. . .

Eunomia is a synthetic OMOP database with \~2,600 individuals. It is freely available and you can download it as:

. . .

```{r}
library(DBI)
library(dplyr)
library(duckdb)
library(omopgenerics)
library(CDMConnector)
library(here)
# downloadEunomiaData(pathToData = here("eunomia"), overwrite = TRUE)
Sys.setenv("EUNOMIA_DATA_FOLDER" = here("eunomia"))
```

. . .

To connect to this database we are going to use `duckdb`

```{r}
db <- dbConnect(duckdb(), dbdir = eunomiaDir())
db
```

## Creating a reference to the OMOP common data model

We already know what the structure of the OMOP CDM looks like. The `CDMConnector` package was made to help you to quickly create a reference to the OMOP CDM data as a whole.

```{r}
library(CDMConnector)
```

-   To install any of these packages that we use you can type: `install.packages("CDMConnector")` in the console.

## Creating a reference to the OMOP common data model

```{r, message=TRUE}
cdm <- cdmFromCon(con = db, cdmSchema = "main", writeSchema = "main")
cdm
```

## Creating a reference to the OMOP common data model

Once we have created the our reference to the overall OMOP CDM, we can reference specific tables using the "\$" operator or \[\[""\]\].

```{r}
cdm$observation_period |> head(2)
```

<br/>

. . .

```{r}
cdm[["observation_period"]] |> head(2)
```

. . .


## Behind the scenes

The omopgenerics package defines core classes and methods used by CDMConnector and analytic packages.

. . .

Having omopgenerics as a central dependency reduces code duplication and ensures consistency across packages (eg function inputs, error messages, and results objects).

. . .

```{r}
omopgenerics::validateCdmArgument(cdm = cdm, 
                                  checkOverlapObservation = TRUE, 
                                  checkStartBeforeEndObservation = TRUE, 
                                  checkPlausibleObservationDates = TRUE)
```


## `<cdm_reference>` object

```{r}
class(cdm)
```

. . .

```{r}
cdmName(cdm)
```

. . .

```{r}
cdmVersion(cdm)
```

. . .

```{r, message=TRUE}
cdmSource(cdm)
```

## `<cdm_table>` object

. . .

```{r}
cdm$person
```

. . .

```{r}
class(cdm$person)
```

## `<cdm_table>` object

. . .

```{r, message=TRUE}
cdmReference(cdm$person)
```

. . .

```{r}
tableName(cdm$person)
```

. . .

```{r, message=TRUE}
tableSource(cdm$person)
```

## `<cdm_table>` object

```{r}
cdmName(cdm$person)
```

. . .

```{r}
cdmVersion(cdm$person)
```

. . .

```{r, message=TRUE}
cdmSource(cdm$person)
```


## Working with the cdm reference

We can use common dplyr operations to interact with the data in our cdm reference

```{r}
cdm$condition_occurrence |> 
  count()
```

<br/>

. . .

```{r}
cdm$condition_occurrence |> 
  summarise(
    min_condition_start = min(condition_start_date, na.rm = TRUE),
    median_condition_start = median(condition_start_date, na.rm = TRUE),
    max_condition_start = max(condition_start_date, na.rm = TRUE))
```


## Dplyr R code to SQL

Behind the scenes our dplyr query is being translated into SQL.

```{r}
cdm$condition_occurrence |> 
  count() |> 
  show_query()
```

. . .

```{r}
cdm$condition_occurrence |> 
  summarise(
    min_condition_start = min(condition_start_date, na.rm = TRUE),
    median_condition_start = median(condition_start_date, na.rm = TRUE),
    max_condition_start = max(condition_start_date, na.rm = TRUE)) |> 
  show_query()
```

## Your turn

Using a cdm reference you have connected to:

1.  How many people are in the person table?

2.  What is the minimum observation period start date?

3.  What is the maximum observation period end date?

